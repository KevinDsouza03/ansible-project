trigger:
- main

pool:
  name: 'Default'

parameters:
  - name: hostname
    type: string
    default: "127.0.0.1"

variables:
  - name: ssh_p
    value: $(SSH_PASSWORD)

stages:
- stage: CreateInventory
  jobs:
  - job: WriteToInventory
    steps: 
    - script: echo "Message ${{ parameters.hostname}}"
      displayName: 'Echo api message'

    - script: |
          echo "[windows]" >> inventory.ini
          echo "${{ parameters.hostname }}" >> inventory.ini

          echo "[windows:vars]" >> inventory.ini
          echo "ansible_user= administrator" >> inventory.ini
          echo "ansible_port= 22" >> inventory.ini
          echo "ansible_connection= ssh" >> inventory.ini
          # In my case, this is all i need
      displayName: 'Generate Ansible Inventory'

    - script: |
          cat inventory.ini
          pwd
      displayName: 'Display Inventory File'

- stage: RunPlaybook
  jobs:
  - job: AnsiblePlaybook
    steps:
    - script: |
        echo " Running Ansible Playbook..."

        # nmap 192.168.122.45 -Pn
        # ping test.com -c 5
        # ssh administrator@test.com
        export ANSIBLE_HOST_KEY_CHECKING=False
        ansible-playbook /home/kdsouza/Project/playbook-test.yml --e "ansible_ssh_pass=$(SSH_PASSWORD) -i inventory.ini -vvvv"
      displayName: Running Playbook


